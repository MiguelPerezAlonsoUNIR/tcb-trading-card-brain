input {
  beats {
    port => 5044
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # Parse Flask/Gunicorn logs
  if [container][name] =~ /onepiece-deck-builder|tcb-app/ {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{LOGLEVEL:log_level}\] %{GREEDYDATA:log_message}" }
      add_tag => ["flask_app"]
    }
  }

  # Add timestamp
  date {
    match => ["timestamp", "ISO8601"]
    target => "@timestamp"
  }

  # Add hostname and service name
  mutate {
    add_field => {
      "service" => "tcb-trading-card-brain"
    }
  }

  # Parse HTTP access logs from nginx
  if [log][file][path] =~ /nginx/ {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
      add_tag => ["nginx"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "tcb-logs-%{+YYYY.MM.dd}"
  }
  
  # Debug output to stdout
  stdout {
    codec => rubydebug
  }
}
