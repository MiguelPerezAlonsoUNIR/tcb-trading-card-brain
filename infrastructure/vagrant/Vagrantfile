# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile for local testing of TCB Trading Card Brain infrastructure

Vagrant.configure("2") do |config|
  # Use Ubuntu 22.04 LTS
  config.vm.box = "ubuntu/jammy64"
  config.vm.hostname = "tcb-dev"

  # Network configuration
  # Forward port 5000 (Flask) to host port 5000
  config.vm.network "forwarded_port", guest: 5000, host: 5000, host_ip: "127.0.0.1"
  # Forward port 80 (Nginx) to host port 8080
  config.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"
  
  # Private network for accessing the VM
  config.vm.network "private_network", type: "dhcp"

  # Provider-specific configuration
  config.vm.provider "virtualbox" do |vb|
    vb.name = "tcb-trading-card-brain"
    vb.memory = "2048"
    vb.cpus = 2
    
    # Enable DNS resolution
    vb.customize ["modifyvm", :id, "--natdnshostresolver1", "on"]
    vb.customize ["modifyvm", :id, "--natdnsproxy1", "on"]
  end

  # Synced folders
  config.vm.synced_folder "../../", "/opt/tcb-trading-card-brain", 
    owner: "vagrant", 
    group: "vagrant"

  # Provision with Ansible
  config.vm.provision "ansible_local" do |ansible|
    ansible.playbook = "../ansible/playbooks/deploy-app.yml"
    ansible.verbose = true
    ansible.install_mode = "pip3"
    ansible.pip_install_cmd = "sudo apt-get install -y python3-pip && sudo pip3 install ansible"
    ansible.extra_vars = {
      app_name: "tcb-trading-card-brain",
      app_user: "vagrant",
      app_dir: "/opt/tcb-trading-card-brain",
      repo_url: "https://github.com/MiguelPerezAlonsoUNIR/tcb-trading-card-brain.git",
      repo_branch: "main",
      secret_key: ENV['TCB_SECRET_KEY'] || "dev-secret-key-for-vagrant-#{rand(10**20)}",
      database_url: "sqlite:///tcb.db",
      flask_env: "development",
      gunicorn_workers: 2,
      initialize_db: true
    }
  end

  # Alternative: Shell provisioning (if Ansible is not available)
  config.vm.provision "shell", inline: <<-SHELL
    echo "=== TCB Trading Card Brain - Vagrant Environment ==="
    echo "Application will be available at:"
    echo "  - Flask direct: http://localhost:5000"
    echo "  - Nginx proxy:  http://localhost:8080"
    echo ""
    echo "To access the VM:"
    echo "  vagrant ssh"
    echo ""
    echo "To see application logs:"
    echo "  sudo journalctl -u tcb-app -f"
  SHELL
end
